## Overview
This repository contains code that create a dataset of global stock returns and characteristics. The dataset was created for the paper [Is There a Replication Crisis in Finance?](https://onlinelibrary.wiley.com/doi/10.1111/jofi.13249) by Jensen, Kelly and Pedersen (2023). Please cite this paper if you are using the code or data: 
```
@article{JensenKellyPedersen2023,
   author = {Jensen, Theis Ingerslev and Kelly, Bryan T and Pedersen, Lasse Heje},
   journal = {Journal of Finance},
   title = {Is There A Replication Crisis In Finance?},
   year = {2023}
}
```
Follow this [link](https://www.dropbox.com/sh/61j1v0sieq9z210/AACdJ68fs5_eT_eJMunwMBWia?dl=0) for a detailed documentation of the data sets.

## How to Generate Global Stock Returns and Stock Characteristics
_Note: The data created in this section can be downloaded directly from WRDS ([link](https://wrds-www.wharton.upenn.edu/pages/get-data/contributed-data-forms/global-factor-data/))_

The .sas files construct the stock-level characteristics and factor portfolio returns for all countries. The code requires a connection to WRDS servers. Below we outline our preferred approach to creating the dataset:

1. Connect to the [SAS studio server hosted by WRDS](https://wrds-cloud.wharton.upenn.edu/SASStudio/index?locale=en_US).  
2. Create a folder called _Global Data_ in your home directory and upload `main.sas`, `project_macros.sas`, `market_chars.sas`, `accounting_chars.sas`, `char_macros.sas`, and `ind_identification.sas` to this folder.
3. Create an empty folder in your institutions scratch folder. The scratch folder is located at "Sever Files and Folders/Files/scratch/\<institution name\>".
4. Open `main.sas`. 
5. Replace line 8 with the path to the scratch folder created in step 3. 
6. Run `main.sas`.  

For step 6, we suggest that you make a background submit. To do so, locate the `main.sas` file in your _Global Data_ folder, right-clik the file and select "Background Submit". Running the code will take around 24-48 hours. 
When the code has finished running, your scratch folder will contain a folder called _output_. This folder contains daily and monthly stocks returns, daily and monthly market returns, market equity breakpoints from NYSE and return breakpoints to use for winsorization. 
If `save_csv=1` on line 12, the folder will also hold the data country-by-country in .csv format. Importantly, these files only include the main observation of ordinary common stocks that are the primary securities of the underlying firm, and traded on a main exchange. To include all stocks, modify the 'save_main_data_csv()' macro. 

Note that the space in the scratch directory is shared across users in your institution. It's best practice to delete files after downloading what you need. Furthermore, files in the scratch directory is deleted after 7 days.

## How to Generate Global Factor Returns
_Note: The data created in this section can be downloaded directly from [JKPfactors.com](https://jkpfactors.com/)_

The file `portfolio.R` generates country level factor returns based on the dataset generated by `main.sas`:

1. Run `main.sas`.
2. Save country level .csv files by running the macro `save_main_data_csv()` in `main.sas`.
3. Download the folder named _output_ to a local directory and unzip.
4. Open `portfolio.R`.
5. User defined inputs:
	1. Replace the variable `data_path` with the path to the folder where you have unzipped the content of _output_.
	2. Replace the variable `output_path` with the path to the folder where you wish to save the factor returns. 
	3. Replace the variable `legacy_path` with the path to the folder where you wish to save earlier versions of the factor output. If you don't wish to save earlier version, set the variabl to         `NULL`.
	4. The variable `countries` controls which countries to generate factor returns for. By default, it selects all the countries in `data_path`.
	5. The variable `chars` controls which characteristics to use for creating factor returns. By default, it is set to the 153 characteristics from Jensen, Kelly and Pedersen (2022). Any             column in the charactersitic dataset can be used to as the basis of a factor. 
	6. The variable `settings` controls the end date, number of portfolio, which breakpoints to use, the data source, whether to winsorize Compustat returns, the minimum amount of stocks for             breakpoints to be valid and whether to create rank weighted (characteristic managed)                  portfolios in each of the 5 size groups. Default settings are the same as used in Jensen,             Kelly and Pedersen (2022).
 6. Run `portfolio.R`.

### Output
**Files**
- `pfs.csv`: We sort stocks into 3 portfolios based on non-microcap breakpoints. Portfolio 1 (3) has the stocks with the lowest (highest) value of the characteristic.
- `hml.csv`: Long/short portfolios that are long stocks with high values of the underlying characteristics (portfolio 3 from pfs.csv) and short stocks with low values (portfolio 1 from pfs.csv). 
- `lms.csv`: Long/short portfolios based on hml.csv but with the signing convention used in Jensen, Kelly and Pedersen (2022). In particular, we sign factors so they are consistent with the literature. For example, we go long low asset growth stocks and short high asset growth stocks, becuase the literature generally finds that low asset growth stocks outperform. 
- `cmp.csv`: Rank-weighted (chracteristic managed) portfolios within mega, large, small, micro and nano cap stocks in the US.
- `market_returns.csv`: Monthly market returns in all the countries we cover.
- `Country Factors`: Folder with lms.csv in country-by-country files for easier usability. Countries are saved by their [ISO Alpha-3 codes](https://www.nationsonline.org/oneworld/country_code_list.htm).  
- `Regional Factors`: Folder with regional factors based on lms.csv and the method in Jensen, Kelly and Pedersen (2022).   

**Variables**
- `excntry`: Country where securities are listed as ISO Alpha-3 codes.
- `eom`: End-of-month of the month used to calculate returns.
- `characteristic`: Name of characteristic, refer to table J.1 in Jensen, Kelly and Pedersen (2022).
- `region`: Region/MSCI country development of included factors. 
- `size_grp`: Size group used to create the rank weighted factors.
- `pf`: Portfolio identifier
- `n`: Total number of stocks in the portfolio.
- `n_stocks`: Total number of stocks in the long and short portfolio.
- `n_stocks_min`: Minimum number of stocks in the long and short portfolio. For example, if the long portfolio has 10 stocks and the short portfolio has 40 stocks, n_stocks=50 and n_stocks_min=10.
- `n_countries`: Number of countries included in regional portfolio.
- `signal` (pfs.csv): Median characteristic value in the portfolio.
- `signal` (hml.csv, lms.csv): Difference between the median characteristics in the long and short portfolio.
- `signal_weighted`: Rank weighted signal.
- `ret_ew`: Return with equal weights.
- `ret_vw`: Return with value weights.
- `ret_vw_cap`: Return with capped value weights as used in Jensen, Kelly and Pedersen (2022).
- `ret_weighted`: Rank weighted returns.
- `me_lag1`: Total market equity within a country at the begining of the month
- `dolvol_lag1`: Total dollar volume traded within a country in the previous month.
- `stocks`: Stocks included in the market portfolio.
- `mkt_vw_lcl`: Value weighted market return in local currency.
- `mkt_ew_lcl`: Equally weighted market return in local currency.
- `mkt_vw`: Value weighted market return in USD.
- `mkt_ew`: Equally weighted market return in USD.
- `mkt_ew_exc`: Equally weighted market excess return in USD.
- `mkt_vw_exc` (market_return.csv): Value weighted market excess return in USD.
- `mkt_vw_exc` (Regional Factors): Market cap weighted average of the market excess return in USD for countries included in the regional portfolio.
